{% extends 'layout.html' %}

{% block title %}Patient Details - HeartCare AI{% endblock %}

{% block head %}
<style>
    .detail-card {
        border: 1px solid var(--border-color);
        border-radius: 10px;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }
    
    .detail-header {
        background: var(--hospital-offwhite);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .detail-body {
        padding: 1.5rem;
    }
    
    .info-row {
        display: flex;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
    }
    
    .info-row:last-child {
        border-bottom: none;
    }
    
    .info-label {
        flex: 0 0 200px;
        font-weight: 600;
        color: var(--text-secondary);
    }
    
    .info-value {
        flex: 1;
    }
    
    .risk-badge {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">Patient Details</h1>
                    <p class="text-muted mb-0">
                        <i class="fas fa-id-card me-2"></i> Patient ID: {{ patient.patient_id }}
                    </p>
                </div>
                <div class="btn-group">
                    <a href="{{ url_for('patients') }}" class="btn btn-outline">
                        <i class="fas fa-arrow-left me-2"></i> Back
                    </a>
                    <a href="{{ url_for('edit_patient', id=patient.id) }}" class="btn btn-primary">
                        <i class="fas fa-edit me-2"></i> Edit
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Basic Information -->
            <div class="detail-card">
                <div class="detail-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i> Basic Information
                    </h5>
                </div>
                <div class="detail-body">
                    <div class="info-row">
                        <div class="info-label">Full Name</div>
                        <div class="info-value">
                            <strong>{{ patient.full_name }}</strong>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Age & Gender</div>
                        <div class="info-value">
                            {{ patient.age }} years â€¢ {{ patient.gender or 'Not specified' }}
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Contact Information</div>
                        <div class="info-value">
                            {% if patient.contact_number %}
                            <div><i class="fas fa-phone me-2"></i> {{ patient.contact_number }}</div>
                            {% endif %}
                            {% if patient.email %}
                            <div class="mt-1"><i class="fas fa-envelope me-2"></i> {{ patient.email }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Address</div>
                        <div class="info-value">
                            {{ patient.address or 'Not specified' }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medical Parameters -->
            <div class="detail-card">
                <div class="detail-header">
                    <h5 class="mb-0">
                        <i class="fas fa-heartbeat me-2"></i> Medical Parameters
                    </h5>
                </div>
                <div class="detail-body">
                    <div class="row">
                        {% for feature in ['cp', 'trestbps', 'chol', 'fbs', 'restecg', 'thalach', 'exang', 'oldpeak', 'slope', 'ca', 'thal'] %}
                        <div class="col-md-4 mb-3">
                            <div class="param-box p-3 border rounded">
                                <div class="param-name text-muted small mb-1">{{ feature }}</div>
                                <div class="param-value h5 mb-0">{{ patient[feature] }}</div>
                                {% if feature == 'cp' %}
                                <div class="param-unit small text-muted mt-1">Chest Pain Type</div>
                                {% elif feature == 'trestbps' %}
                                <div class="param-unit small text-muted mt-1">mmHg</div>
                                {% elif feature == 'chol' %}
                                <div class="param-unit small text-muted mt-1">mg/dl</div>
                                {% elif feature == 'thalach' %}
                                <div class="param-unit small text-muted mt-1">bpm</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Clinical Notes -->
            {% if patient.prediction_notes %}
            <div class="detail-card">
                <div class="detail-header">
                    <h5 class="mb-0">
                        <i class="fas fa-notes-medical me-2"></i> Clinical Notes
                    </h5>
                </div>
                <div class="detail-body">
                    <p>{{ patient.prediction_notes }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Prediction Results -->
            <div class="detail-card">
                <div class="detail-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i> Prediction Results
                    </h5>
                </div>
                <div class="detail-body">
                    <div class="text-center mb-4">
                        {% if patient.prediction_result == 1 %}
                        <div class="risk-badge bg-danger bg-opacity-10 text-danger mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            HIGH RISK DETECTED
                        </div>
                        {% else %}
                        <div class="risk-badge bg-success bg-opacity-10 text-success mb-3">
                            <i class="fas fa-check-circle me-2"></i>
                            LOW RISK
                        </div>
                        {% endif %}
                        
                        <div class="mb-4">
                            <div class="h1 mb-2">
                                {% if patient.prediction_probability %}
                                {{ (patient.prediction_probability * 100)|round(1) }}%
                                {% else %}
                                N/A
                                {% endif %}
                            </div>
                            <div class="text-muted">Risk Probability</div>
                        </div>
                        
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar {% if patient.prediction_result == 1 %}bg-danger{% else %}bg-success{% endif %}" 
                                 style="width: {% if patient.prediction_probability %}{{ patient.prediction_probability * 100 }}%{% else %}0%{% endif %}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert {% if patient.prediction_result == 1 %}alert-danger{% else %}alert-success{% endif %}">
                        <h6 class="alert-heading">
                            {% if patient.prediction_result == 1 %}
                            <i class="fas fa-exclamation-triangle me-2"></i> Recommendation
                            {% else %}
                            <i class="fas fa-check-circle me-2"></i> Assessment
                            {% endif %}
                        </h6>
                        <p class="mb-0">
                            {% if patient.prediction_result == 1 %}
                            This patient shows indicators of potential heart disease. 
                            Recommend consultation with cardiologist and further testing.
                            {% else %}
                            Patient shows low risk indicators. 
                            Recommend regular check-ups and healthy lifestyle maintenance.
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Record Information -->
            <div class="detail-card">
                <div class="detail-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i> Record Information
                    </h5>
                </div>
                <div class="detail-body">
                    <div class="info-row">
                        <div class="info-label">Patient ID</div>
                        <div class="info-value">
                            <code>{{ patient.patient_id }}</code>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Created By</div>
                        <div class="info-value">
                            {{ patient.created_by_name or 'Unknown' }}
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Created On</div>
                        <div class="info-value">
                            {{ patient.created_at[:19] }}
                        </div>
                    </div>
                    {% if patient.updated_at and patient.updated_at != patient.created_at %}
                    <div class="info-row">
                        <div class="info-label">Last Updated</div>
                        <div class="info-value">
                            {{ patient.updated_at[:19] }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="detail-card">
                <div class="detail-body">
                    <h6 class="mb-3">Quick Actions</h6>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('edit_patient', id=patient.id) }}" class="btn btn-primary">
                            <i class="fas fa-edit me-2"></i> Edit Patient
                        </a>
                        <a href="{{ url_for('predict') }}" class="btn btn-outline">
                            <i class="fas fa-calculator me-2"></i> New Prediction
                        </a>
                        <button type="button" class="btn btn-outline" data-bs-toggle="modal" 
                                data-bs-target="#deleteModal">
                            <i class="fas fa-trash me-2"></i> Delete Record
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this patient record?</p>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This will permanently delete all data for 
                    <strong>{{ patient.full_name }}</strong> ({{ patient.patient_id }}).
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('delete_patient', id=patient.id) }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i> Delete Permanently
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}