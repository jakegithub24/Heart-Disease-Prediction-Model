{% extends 'layout.html' %}

{% block title %}{% if patient %}Edit{% else %}New{% endif %} Patient - HeartCare AI{% endblock %}

{% block head %}
<style>
    .section-card {
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        overflow: hidden;
    }

    .section-header {
        background: var(--hospital-offwhite);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .section-body {
        padding: 1.5rem;
    }

    .param-input-group {
        position: relative;
    }

    .param-input-group input {
        padding-right: 40px;
    }

    .param-unit {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 0.875rem;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-2">
                        {% if patient %}
                        <i class="fas fa-user-edit me-2"></i> Edit Patient
                        {% else %}
                        <i class="fas fa-user-plus me-2"></i> New Patient
                        {% endif %}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if patient %}
                        Update patient information and medical parameters
                        {% else %}
                        Add a new patient record with medical parameters
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('patients') }}" class="btn btn-outline">
                        <i class="fas fa-arrow-left me-2"></i> Back to Patients
                    </a>
                </div>
            </div>

            <form method="POST" id="patientForm">
                <!-- Basic Information Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h5 class="mb-0">
                            <i class="fas fa-id-card me-2"></i> Basic Information
                        </h5>
                    </div>
                    <div class="section-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Full Name *</label>
                                <input type="text" name="full_name" class="form-control"
                                    value="{{ patient.full_name if patient else '' }}" required>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Age *</label>
                                <input type="number" name="age" class="form-control" min="0" max="120"
                                    value="{{ patient.age if patient else '' }}" required>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Gender</label>
                                <select name="gender" class="form-select">
                                    <option value="">Select Gender</option>
                                    <option value="Male" {% if patient and patient.gender=='Male' %}selected{% endif %}>
                                        Male</option>
                                    <option value="Female" {% if patient and patient.gender=='Female' %}selected{% endif
                                        %}>Female</option>
                                    <option value="Other" {% if patient and patient.gender=='Other' %}selected{% endif
                                        %}>Other</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Contact Number</label>
                                <input type="tel" name="contact_number" class="form-control"
                                    value="{{ patient.contact_number if patient else '' }}">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Email Address</label>
                                <input type="email" name="email" class="form-control"
                                    value="{{ patient.email if patient else '' }}">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Address</label>
                                <textarea name="address" class="form-control"
                                    rows="2">{{ patient.address if patient else '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Medical Parameters Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h5 class="mb-0">
                            <i class="fas fa-heartbeat me-2"></i> Medical Parameters
                        </h5>
                        <p class="small text-muted mb-0 mt-1">
                            Enter the clinical parameters for heart disease prediction
                        </p>
                    </div>
                    <div class="section-body">
                        <div class="row g-3">
                            {% for feature in features %}
                            <div class="col-md-4">
                                <div class="param-input-group">
                                    <label class="form-label">{{ feature }}</label>
                                    <input type="text" name="{{ feature }}" class="form-control"
                                        value="{{ patient[feature] if patient else '' }}" placeholder="Enter value"
                                        required>
                                    {% if 'age' in feature.lower() %}
                                    <span class="param-unit">years</span>
                                    {% elif 'bp' in feature.lower() %}
                                    <span class="param-unit">mmHg</span>
                                    {% elif 'chol' in feature.lower() %}
                                    <span class="param-unit">mg/dl</span>
                                    {% elif 'thalach' in feature.lower() %}
                                    <span class="param-unit">bpm</span>
                                    {% elif 'oldpeak' in feature.lower() %}
                                    <span class="param-unit">mm</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="alert alert-info mt-3">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i> Parameter Guidelines
                            </h6>
                            <ul class="small mb-0">
                                <li><strong>cp (Chest Pain Type):</strong> 1 = typical angina, 2 = atypical angina, 3 =
                                    non-anginal pain, 4 = asymptomatic</li>
                                <li><strong>trestbps (Resting BP):</strong> Normal range: 90-120 mmHg</li>
                                <li><strong>chol (Cholesterol):</strong> Normal range: < 200 mg/dl</li>
                                <li><strong>thalach (Max Heart Rate):</strong> 220 - age (approx)</li>
                                <li><strong>oldpeak (ST Depression):</strong> 0-4 mm</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h5 class="mb-0">
                            <i class="fas fa-notes-medical me-2"></i> Clinical Notes
                        </h5>
                    </div>
                    <div class="section-body">
                        <div class="mb-3">
                            <label class="form-label">Prediction Notes</label>
                            <textarea name="prediction_notes" class="form-control" rows="3"
                                placeholder="Enter any additional clinical notes or observations...">{{ patient.prediction_notes if patient else '' }}</textarea>
                        </div>

                        {% if patient %}
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Current Prediction</h6>
                                        {% if patient.prediction_result == 1 %}
                                        <div class="alert alert-danger mb-0">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>High Risk</strong> - {{ (patient.prediction_probability *
                                            100)|round(1) if patient.prediction_probability else 'N/A' }}%
                                        </div>
                                        {% else %}
                                        <div class="alert alert-success mb-0">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <strong>Low Risk</strong> - {{ (patient.prediction_probability *
                                            100)|round(1) if patient.prediction_probability else 'N/A' }}%
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Record Information</h6>
                                        <p class="small mb-1"><strong>Patient ID:</strong> {{ patient.patient_id }}</p>
                                        <p class="small mb-1"><strong>Created:</strong> {{ patient.created_at }}</p>
                                        {% if patient.updated_at and patient.updated_at != patient.created_at %}
                                        <p class="small mb-0"><strong>Last Updated:</strong> {{ patient.updated_at }}
                                        </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{{ url_for('patients') }}" class="btn btn-outline">
                        <i class="fas fa-times me-2"></i> Cancel
                    </a>
                    <div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            {% if patient %}Update Patient{% else %}Save Patient{% endif %}
                        </button>
                        {% if patient %}
                        <button type="button" class="btn btn-outline" onclick="runPrediction()">
                            <i class="fas fa-calculator me-2"></i> Recalculate Prediction
                        </button>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function runPrediction() {
        // Collect form data and run prediction without saving
        const form = document.getElementById('patientForm');
        const formData = new FormData(form);
        const params = {};

        // Extract feature values
        {% for feature in features %}
        params['{{ feature }}'] = formData.get('{{ feature }}');
        {% endfor %}

        // Basic validation
        let isValid = true;
        for (const [key, value] of Object.entries(params)) {
            if (!value || isNaN(value)) {
                alert(`Please enter a valid numeric value for ${key}`);
                isValid = false;
                break;
            }
        }

        if (isValid) {
            // Show loading
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Calculating...';
            btn.disabled = true;

            // Simulate prediction calculation
            setTimeout(() => {
                alert('Prediction would be recalculated when you save the form.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 1000);
        }
    }

    // Auto-format numeric inputs
    document.querySelectorAll('input[name^="cp"], input[name^="trestbps"], input[name^="chol"], input[name^="fbs"], input[name^="restecg"], input[name^="thalach"], input[name^="exang"], input[name^="oldpeak"], input[name^="slope"], input[name^="ca"], input[name^="thal"]').forEach(input => {
        input.addEventListener('input', function (e) {
            this.value = this.value.replace(/[^0-9.]/g, '');
        });
    });
</script>
{% endblock %}